# Implementation Plan

- [x] 1. ENUM定義をスキーマの一級要素として扱えるようにする
- [x] 1.1 ENUM定義（型名と値順序）をスキーマに保持できるようにする
  - ENUM定義を追加・参照できる状態モデルを整える
  - 値順序が比較と再生成の基準になることを前提化する
  - _Requirements: 1.1, 4.3_

- [x] 1.2 YAMLでENUM定義と参照を表現できるようにする
  - スキーマ読込時にトップレベルのENUM定義を受け取れるようにする
  - 既存スキーマの読み込み互換性を維持する
  - _Requirements: 1.1, 4.3_

- [x] 2. ENUM定義の検証ロジックを追加する
- [x] 2.1 (P) ENUM値の空リストと重複を検出する
  - 空の値リストを検証エラーとして扱う
  - 重複値を検出して明示的に報告する
  - _Requirements: 1.2, 1.3_

- [x] 2.2 (P) ENUM参照の整合性と方言制約を検証する
  - 未定義のENUM参照を検出する
  - PostgreSQL以外の方言ではENUM定義を無効として扱う
  - _Requirements: 1.4, 1.5_

- [x] 2.3 (P) ENUM検証のユニットテストを追加する
  - 正常系と異常系の検証結果を確認する
  - _Requirements: 1.2, 1.3, 1.4, 1.5_

- [x] 3. PostgreSQLのENUM定義をエクスポートに含める
- [x] 3.1 (P) PostgreSQLのメタ情報からENUM定義を取得できるようにする
  - 型名と値順序を取得できる状態にする
  - _Requirements: 4.1, 4.2_

- [x] 3.2 (P) エクスポート結果にENUM定義を統合する
  - スキーマ出力にENUM定義を含める
  - 再読込で同等定義として解釈できる形式にする
  - _Requirements: 4.1, 4.3_

- [x] 3.3 (P) ENUMエクスポートのテストを追加する
  - 値順序の保持と再読込の等価性を確認する
  - _Requirements: 4.2, 4.3_

- [x] 4. ENUM差分検出と変更分類を追加する
- [x] 4.1 ENUMの追加・削除・変更を差分として抽出する
  - 値順序の変更を差分として扱う
  - _Requirements: 2.2, 2.4_

- [x] 4.2 変更種別（追加のみ vs 再作成）を判定できるようにする
  - 値の追加は追加扱い、削除/並び替えは再作成扱いに分類する
  - _Requirements: 2.2, 2.4_

- [x] 4.3 削除/並び替えのオプトイン有無を判定する
  - 明示的オプトインが無い場合は拒否される条件を定義する
  - _Requirements: 2.2, 3.1, 3.2_

- [x] 4.4 ENUM差分検出のユニットテストを追加する
  - 追加/変更/削除/変更なしのケースを確認する
  - _Requirements: 2.2, 2.4_

- [x] 5. ENUMのマイグレーションDDLを生成する
- [x] 5.1 ENUM作成・削除DDLをマイグレーションに組み込む
  - 新規作成はテーブル作成前に実行されるよう順序を制御する
  - 削除は参照解除後に実行されるようにする
  - _Requirements: 2.1, 2.3_

- [x] 5.2 ENUM変更のDDL生成戦略を反映する
  - 追加はALTER TYPEで扱い、削除/並び替えはオプトイン時のみ再作成フローで扱う
  - _Requirements: 2.2_

- [x] 5.3 オプトイン未指定時に削除/並び替えを拒否する
  - 明示的オプトインが無い場合はDDL生成を失敗として扱う
  - _Requirements: 2.2, 3.1, 3.2_

- [x] 5.4 ENUMのDDL生成テストを追加する
  - 作成・追加・削除・変更なしのケースを確認する
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 6. ENUMを含む適用・ロールバックの整合性を確認する
- [x] 6.1 適用失敗時に未適用として扱うことを確認する
  - ENUM DDL失敗時の報告と履歴の扱いを検証する
  - _Requirements: 3.1, 3.2_

- [x] 6.2 ロールバック時に直前のENUM定義へ戻ることを確認する
  - ENUM変更を含むロールバックの動作を検証する
  - _Requirements: 3.3_

- [x] 6.3 ENUM適用/ロールバックの統合テストを追加する
  - 生成・適用・ロールバックの一連フローを確認する
  - _Requirements: 3.1, 3.2, 3.3_
