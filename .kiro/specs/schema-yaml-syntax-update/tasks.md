# Implementation Plan

## Task 1: DTO層の実装

- [ ] 1.1 (P) スキーマDTO構造体を作成する
  - YAMLスキーマファイルの構造を表現する中間データ型を定義
  - バージョン、ENUM定義、テーブル定義のマッピングを保持
  - オプショナルフィールドにはデフォルト値を設定し、空の場合はシリアライズ時に除外
  - _Requirements: 1.1, 2.1, 3.1, 4.1_

- [ ] 1.2 (P) テーブルDTO構造体を作成する
  - テーブル定義の中間データ型を定義（`name`フィールドを持たない）
  - カラム定義は必須、その他はオプショナル
  - 主キーは独立したフィールドとしてカラム名リストを保持
  - インデックスと制約はオプショナルで、デフォルトは空リスト
  - シリアライズ時に空のリストは出力しない設定を追加
  - _Requirements: 1.2, 2.1, 2.3, 3.1, 3.2, 3.3, 4.1, 4.2, 4.3_

- [ ] 1.3 (P) 制約DTO列挙型を作成する
  - FOREIGN_KEY、UNIQUE、CHECKの3種類のみを定義（PRIMARY_KEYは含まない）
  - 各制約タイプに必要なフィールドを定義
  - YAMLの`type`フィールドで制約タイプを判別できるようタグ付けを設定
  - _Requirements: 2.3_

## Task 2: パーサーの拡張

- [ ] 2.1 DTOから内部モデルへの変換ロジックを実装する
  - スキーマDTOを受け取り、内部スキーマモデルに変換
  - テーブルDTOのHashMapキー名をテーブル名として設定
  - ENUM定義は既存の形式をそのまま引き継ぐ
  - _Requirements: 1.1_

- [ ] 2.2 テーブル変換で主キーを制約に変換する処理を実装する
  - テーブルDTOの主キーフィールドが存在する場合、内部モデルのPRIMARY_KEY制約として生成
  - 制約DTOの各タイプを内部モデルの制約に変換
  - カラム、インデックスは既存の形式で引き継ぐ
  - _Requirements: 2.1, 2.2, 4.6_

- [ ] 2.3 パースエラーから行番号を抽出する処理を実装する
  - YAMLパースエラーのメッセージから行番号を正規表現で抽出
  - ファイルパスと行番号を含むエラーメッセージを生成
  - 行番号が取得できない場合はファイルパスのみでフォールバック
  - _Requirements: 5.3_

- [ ] 2.4 既存のパースメソッドをDTO経由に変更する
  - YAMLファイルをまずDTOにデシリアライズ
  - DTOを内部モデルに変換して返却
  - 変換時のエラーにはコンテキスト情報を付加
  - _Requirements: 1.1, 2.2, 3.1, 3.2, 4.1, 4.2, 5.2_

## Task 3: シリアライザーの新規作成

- [ ] 3.1 スキーマシリアライザーサービスを作成する
  - 内部スキーマモデルをYAML文字列に変換するサービスを新規作成
  - 文字列への変換とファイル出力の両メソッドを提供
  - _Requirements: 1.3, 2.5_

- [ ] 3.2 内部モデルからDTOへの変換ロジックを実装する
  - スキーマモデルからスキーマDTOを生成
  - テーブル名をHashMapのキーとして使用
  - ENUM定義は既存の形式で引き継ぐ
  - _Requirements: 1.3_

- [ ] 3.3 テーブル変換でPRIMARY_KEY制約を主キーフィールドに抽出する処理を実装する
  - PRIMARY_KEY制約を探し、存在すれば主キーフィールドとして設定
  - PRIMARY_KEY以外の制約を制約DTOリストに変換
  - 空のインデックス・制約リストはシリアライズ時に自動除外
  - _Requirements: 2.5, 3.4, 4.4_

## Task 4: コマンド統合

- [ ] 4.1 エクスポートコマンドのシリアライズ処理を新サービス経由に変更する
  - データベースからエクスポートしたスキーマを新構文形式で出力
  - シリアライザーサービスを使用してYAML生成
  - _Requirements: 1.3, 2.5_

- [ ] 4.2 マイグレーション生成のスナップショット保存を新サービス経由に変更する
  - スキーマスナップショットファイルを新構文形式で保存
  - シリアライザーサービスを使用してYAML生成
  - _Requirements: 1.3, 2.5_

## Task 5: 例示ファイルの更新

- [ ] 5. 例示スキーマファイルを新構文に更新する
  - 既存の例示ファイルから`name`フィールドを削除
  - `constraints`内のPRIMARY_KEYを`primary_key`フィールドに移動
  - 不要な空の`indexes`と`constraints`を削除
  - 更新後のファイルでパース・シリアライズが正常動作することを確認
  - _Requirements: 1.1, 1.2, 2.1, 2.3, 3.1, 4.1_

## Task 6: テスト

- [ ] 6.1 DTO層の単体テストを作成する
  - 新構文YAMLのデシリアライズテスト
  - オプショナルフィールド省略時のデフォルト値テスト
  - シリアライズ時の空フィールド除外テスト
  - 制約DTOの各タイプの変換テスト
  - _Requirements: 1.1, 1.2, 2.1, 2.3, 3.1, 3.2, 3.3, 4.1, 4.2, 4.3_

- [ ] 6.2 パーサー拡張の単体テストを作成する
  - テーブル名がキー名から正しく設定されるテスト
  - 主キーがPRIMARY_KEY制約に変換されるテスト
  - 行番号抽出ロジックのテスト
  - カラム未定義エラーのテスト
  - _Requirements: 1.1, 2.2, 5.2, 5.3_

- [ ] 6.3 シリアライザーの単体テストを作成する
  - テーブル名がキー名として出力されるテスト
  - PRIMARY_KEY制約が主キーフィールドとして出力されるテスト
  - 空のインデックス・制約が出力されないテスト
  - _Requirements: 1.3, 2.5, 3.4, 4.4_

- [ ] 6.4 統合テストを作成する
  - パース→シリアライズの往復テスト（round-trip）
  - 既存バリデーションとの連携テスト（PRIMARY_KEYカラム存在確認）
  - SQL Generator出力確認テスト（変更なしを確認）
  - _Requirements: 2.4, 3.5, 4.5, 5.1_
